-- Setup TEST Database Schema with Authorization System
-- Run this in your TEST Supabase SQL Editor

-- Create authorization system tables
CREATE TABLE IF NOT EXISTS roles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(50) UNIQUE NOT NULL,
    description TEXT,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    role_id UUID REFERENCES roles(id),
    company_code VARCHAR(10),
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS authorization_objects (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    object_name VARCHAR(100) UNIQUE NOT NULL,
    description TEXT,
    module VARCHAR(50),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS role_authorization_objects (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    role_id UUID REFERENCES roles(id),
    auth_object_id UUID REFERENCES authorization_objects(id),
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS user_roles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    role_id UUID REFERENCES roles(id),
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS tiles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tile_title VARCHAR(255) NOT NULL,
    tile_category VARCHAR(100),
    auth_object VARCHAR(100),
    route_path VARCHAR(255),
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Create basic tables for testing
CREATE TABLE IF NOT EXISTS projects (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_code VARCHAR(50) UNIQUE NOT NULL,
    project_name VARCHAR(255) NOT NULL,
    project_type VARCHAR(50) NOT NULL,
    company_code VARCHAR(10) NOT NULL,
    status VARCHAR(20) DEFAULT 'ACTIVE',
    test_run_id UUID,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Project creation support tables
CREATE TABLE IF NOT EXISTS project_categories (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    category VARCHAR(100) NOT NULL,
    prefix VARCHAR(10) NOT NULL,
    description TEXT
);

CREATE TABLE IF NOT EXISTS project_types (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    type_code VARCHAR(50) NOT NULL,
    type_name VARCHAR(100) NOT NULL,
    category_code VARCHAR(100),
    description TEXT
);

CREATE TABLE IF NOT EXISTS company_codes (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    company_code VARCHAR(10) UNIQUE NOT NULL,
    company_name VARCHAR(255) NOT NULL
);

CREATE TABLE IF NOT EXISTS cost_centers (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    cost_center_code VARCHAR(20) NOT NULL,
    cost_center_name VARCHAR(255) NOT NULL,
    department VARCHAR(100),
    company_code VARCHAR(10)
);

CREATE TABLE IF NOT EXISTS profit_centers (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    profit_center_code VARCHAR(20) NOT NULL,
    profit_center_name VARCHAR(255) NOT NULL,
    division VARCHAR(100),
    company_code VARCHAR(10)
);

CREATE TABLE IF NOT EXISTS plants (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    plant_code VARCHAR(10) NOT NULL,
    plant_name VARCHAR(255) NOT NULL,
    location VARCHAR(255),
    company_code VARCHAR(10)
);

CREATE TABLE IF NOT EXISTS persons_responsible (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    role VARCHAR(100) NOT NULL,
    email VARCHAR(255),
    company_code VARCHAR(10)
);

CREATE TABLE IF NOT EXISTS numbering_patterns (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    pattern VARCHAR(100) NOT NULL,
    description TEXT,
    entity_type VARCHAR(50),
    company_code VARCHAR(10)
);

CREATE TABLE IF NOT EXISTS universal_journal (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    company_code VARCHAR(10) NOT NULL,
    project_code VARCHAR(50),
    gl_account VARCHAR(10) NOT NULL,
    debit_credit CHAR(1) CHECK (debit_credit IN ('D', 'C')),
    company_amount DECIMAL(15,2) NOT NULL,
    event_type VARCHAR(50),
    posting_date DATE DEFAULT CURRENT_DATE,
    test_run_id UUID,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS test_users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    role VARCHAR(50) NOT NULL,
    company_code VARCHAR(10) NOT NULL,
    test_run_id UUID NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Insert authorization system data
INSERT INTO roles (name, description) VALUES 
('Admin', 'System Administrator'),
('Manager', 'Project Manager'),
('Engineer', 'Site Engineer')
ON CONFLICT (name) DO NOTHING;

INSERT INTO authorization_objects (object_name, description, module) VALUES 
('PROJECT_CREATE', 'Create new projects', 'Projects'),
('PROJECT_VIEW', 'View projects', 'Projects'),
('FINANCE_VIEW', 'View financial data', 'Finance'),
('ADMIN_ACCESS', 'Administrative access', 'Admin')
ON CONFLICT (object_name) DO NOTHING;

-- Create admin user
INSERT INTO users (email, role_id, company_code) 
SELECT 'admin@nttdemo.com', r.id, 'TEST'
FROM roles r WHERE r.name = 'Admin'
ON CONFLICT (email) DO NOTHING;

-- Assign all permissions to Admin role
INSERT INTO role_authorization_objects (role_id, auth_object_id)
SELECT r.id, ao.id
FROM roles r, authorization_objects ao
WHERE r.name = 'Admin'
ON CONFLICT DO NOTHING;

-- Create project creation tile
INSERT INTO tiles (tile_title, tile_category, auth_object, route_path) VALUES 
('Create Project', 'Projects', 'PROJECT_CREATE', '/engineer'),
('View Projects', 'Projects', 'PROJECT_VIEW', '/projects'),
('Finance Dashboard', 'Finance', 'FINANCE_VIEW', '/finance')
ON CONFLICT DO NOTHING;

-- Insert sample test data
INSERT INTO projects (project_code, project_name, project_type, company_code) VALUES
('SAMPLE-001', 'Sample Construction Project', 'CONSTRUCTION', 'TEST'),
('SAMPLE-002', 'Sample Infrastructure Project', 'INFRASTRUCTURE', 'TEST')
ON CONFLICT (project_code) DO NOTHING;

-- Insert project creation support data
INSERT INTO project_categories (category, prefix, description) VALUES 
('CONSTRUCTION', 'CONS', 'Construction Projects'),
('INFRASTRUCTURE', 'INFRA', 'Infrastructure Projects'),
('COMMERCIAL', 'COMM', 'Commercial Projects');

INSERT INTO project_types (type_code, type_name, category_code, description) VALUES 
('RESIDENTIAL', 'Residential Building', 'CONSTRUCTION', 'Residential construction'),
('COMMERCIAL', 'Commercial Building', 'CONSTRUCTION', 'Commercial construction'),
('ROAD', 'Road Construction', 'INFRASTRUCTURE', 'Road infrastructure'),
('BRIDGE', 'Bridge Construction', 'INFRASTRUCTURE', 'Bridge infrastructure');

INSERT INTO company_codes (company_code, company_name) VALUES 
('TEST', 'Test Construction Company'),
('C001', 'Main Construction Ltd');

INSERT INTO cost_centers (cost_center_code, cost_center_name, department, company_code) VALUES 
('CC001', 'Project Management', 'Operations', 'TEST'),
('CC002', 'Site Operations', 'Construction', 'TEST'),
('CC003', 'Quality Control', 'QA', 'TEST');

INSERT INTO profit_centers (profit_center_code, profit_center_name, division, company_code) VALUES 
('PC001', 'Construction Division', 'Construction', 'TEST'),
('PC002', 'Infrastructure Division', 'Infrastructure', 'TEST');

INSERT INTO plants (plant_code, plant_name, location, company_code) VALUES 
('P001', 'Main Site', 'Mumbai', 'TEST'),
('P002', 'Secondary Site', 'Delhi', 'TEST');

INSERT INTO persons_responsible (name, role, email, company_code) VALUES 
('John Manager', 'project_manager', 'john@test.com', 'TEST'),
('Jane Engineer', 'site_supervisor', 'jane@test.com', 'TEST'),
('Bob Architect', 'architect', 'bob@test.com', 'TEST');

INSERT INTO numbering_patterns (pattern, description, entity_type, company_code) VALUES 
('TEST-{YYYY}-{###}', 'Test project numbering', 'PROJECT', 'TEST'),
('CONS-{MM}-{####}', 'Construction project pattern', 'PROJECT', 'TEST');

-- Create indexes
CREATE INDEX IF NOT EXISTS idx_projects_test_run_id ON projects(test_run_id);
CREATE INDEX IF NOT EXISTS idx_universal_journal_test_run_id ON universal_journal(test_run_id);
CREATE INDEX IF NOT EXISTS idx_test_users_test_run_id ON test_users(test_run_id);
CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);
CREATE INDEX IF NOT EXISTS idx_role_auth_objects ON role_authorization_objects(role_id, auth_object_id);